<!DOCTYPE html>
<html>

    <head>
        <meta charset="UTF-8">
        <title>Project Money Tracker</title>
        <link rel="stylesheet" href="./node_modules/material-design-icons/iconfont/material-icons.css">
        <link rel="stylesheet" href="./node_modules/materialize-css/dist/css/materialize.min.css">
        <script src="./node_modules/materialize-css/js/hammer.min.js" onload="window.Hammer = module.exports;"></script>
        <script src="./node_modules/materialize-css/dist/js/materialize.min.js"></script>
        <script src="./node_modules/chart.js/dist/Chart.bundle.min.js"></script>
    </head>

    <body>
        <ul id="slide-out" class="side-nav">
            <li class="side-nav-header">
                <div class="user-view">
                    <div class="background">
                        <img src="./assets/images/user_backgroud.jpg">
                    </div>
                    <a href="#!name">
                        <span class="white-text name">John Doe</span>
                    </a>
                    <a href="#!email">
                        <span class="white-text email">&nbsp;</span>
                    </a>
                </div>
            </li>
            <li class="project-item">
                <a class="waves-effect" role="button">Project name</a>
            </li>
        </ul>
        <nav class="light-blue darken-1">
            <div class="nav-wrapper">
                <a href="#" class="brand-logo center" id="project-name">Project name</a>
                <a href="#" data-activates="slide-out" class="button-collapse show-on-large show-on-medium show-on-small">
                    <i class="material-icons">menu</i>
                </a>
            </div>
        </nav>

        <div class="container">
            <div class="section">
                <div class="row">
                    <div class="col s12">
                        <h5>
                            Descrizione
                        </h5>
                        <p id="project-description">Lorem ipsum dolor sit amet consectetur adipisicing elit. Delectus sed reiciendis ullam rem, laudantium libero consequatur nemo necessitatibus error illo earum expedita id magnam! Quae nulla saepe deleniti nam et expedita laborum labore similique quod beatae eos unde dolore provident tempora, consequatur esse voluptatem quas sunt reiciendis est delectus quisquam rem. Ullam voluptatum doloremque in unde repellendus? Neque saepe accusamus facilis culpa repellat ut dolores commodi iusto inventore amet blanditiis praesentium velit, aperiam harum pariatur error, numquam mollitia corporis. Aspernatur numquam quis dolore at! Animi amet ipsum eligendi omnis sequi nam voluptate nisi rem, velit quia neque maxime, et vero?</p>
                    </div>
                </div>
            </div>
            <div class="section">
                <div class="row center-align">
                    <div class="col m8 s12">
                        <h5>Tabella degli acconti</h5>
                        <table class="bordered responsive-table centered">
                            <thead>
                                <tr>
                                    <th>Accounto</th>
                                    <th>Data</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>150,00€</td>
                                    <td>21-12-2017</td>
                                </tr>
                                <tr>
                                    <td>150,00€</td>
                                    <td>21-12-2017</td>
                                </tr>
                                <tr>
                                    <td>150,00€</td>
                                    <td>21-12-2017</td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="section left-align">
                            <a class="waves-effect waves-light btn light-blue darken-1 modal-trigger" href="#addDepositModal">Inserisci</a>
                        </div>

                    </div>
                    <div class="col m4 s12">
                        <h5>Grafico</h5>
                        <canvas id="costsCanvas" width="400" height="400"></canvas>
                    </div>
                </div>
            </div>
            <div class="fixed-action-btn horizontal click-to-toggle">
                <a id="addProjectButton" class="btn-floating btn-large red waves-effect waves-light">
                    <i class="material-icons">add</i>
                </a>
            </div>
        </div>

        <!-- Add new project modal -->
        <div id="addProjectModal" class="modal modal-fixed-footer">
            <div class="modal-content">
                <h4>Create a new Project</h4>
                <div class="row">
                    <form class="col s12">
                        <div class="row">
                            <div class="col s12 input-field">
                                <input type="text" id="iProjectName">
                                <label for="iProjectName">Project Name</label>
                            </div>
                        </div>
                        <div class="row">
                            <div class="input-field col s12">
                                <textarea id="iProjectDescription" class="materialize-textarea"></textarea>
                                <label for="iProjectDescription">Description</label>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <a role="button" id="saveProjectButton" class="modal-action modal-close waves-effect waves-green btn-flat">Create</a>
            </div>
        </div>

        <!-- Add new deposit modal -->
        <div id="addDepositModal" class="modal modal-fixed-footer">
            <div class="modal-content">
                <h4>Add a new deposit</h4>
                <div class="row">
                    <form class="col s12">
                        <div class="row">
                            <div class="col s12 input-field">
                                <input type="number" id="iDeposit">
                                <label for="iDeposit">Deposit</label>
                            </div>
                        </div>
                        <div class="row">
                            <div class="input-field col s12">
                                <input type="text" class="datepicker" id="iDepositDate">
                                <label for="iDepositDate">Deposit date</label>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <a role="button" id="addProjectDeposit" class="modal-action modal-close waves-effect waves-green btn-flat">Add</a>
            </div>
        </div>


        <script>
            // You can also require other files to run in this process
            require('./renderer.js');
            const electron = require('electron')
            const { ipcRenderer } = electron;

            const slideOutButton = $(".button-collapse");
            slideOutButton.sideNav();
            slideOutButton.on("click", function(){
                ipcRenderer.send("slideOut:open");
            });

            var ctx = document.getElementById("costsCanvas").getContext('2d');
            var myChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: [
                        "Dati", "Da dare"
                    ],
                    datasets: [
                        {
                            label: 'Acconti',
                            data: [
                                350, 150
                            ],
                            backgroundColor: [
                                'rgba(129, 212, 83, 1)', 'rgba(54, 162, 235, 1)'
                            ],
                            borderColor: [
                                'rgba(129, 212, 83, 1)', 'rgba(54, 162, 235, 1)'
                            ],
                            hoverBackgroundColor: [
                                'rgba(129, 212, 83, 1)', 'rgba(54, 162, 235, 1)'
                            ],
                            borderWidth: 1
                        }
                    ]
                },
                options: {}
            });

            $(document).ready(function () {
                $('.modal').modal();
                $('.datepicker').pickadate({
                    selectMonths: true, // Creates a dropdown to control month
                    selectYears: 15, // Creates a dropdown of 15 years to control year,
                    today: 'Today',
                    clear: 'Clear',
                    close: 'Ok',
                    closeOnSelect: false // Close upon selecting a date,
                  });

                const addProjectModal = $('#addProjectModal');
                
                $('#addProjectButton').on('click', function (e) {
                    addProjectModal.modal('open');
                });

                // Saving new projects
                $('#saveProjectButton').on('click', function(e) {
                    const iProjectName = $('#iProjectName');
                    const iProjectDescription = $('#iProjectDescription');
                    const projectName = iProjectName.val();
                    const projectDescription = iProjectDescription.val();

                    if (projectName.trim() === '') {
                        return;
                    }

                    ipcRenderer.send('project:add', {'name': projectName, 'description': projectDescription});

                    addProjectModal.modal('close');
                    iProjectName.val(null);
                    iProjectDescription.val(null);
                    iProjectDescription.trigger('autoresize');
                });

                // Saving new deposits
                $('#addProjectDeposit').on('click', function(e) {
                    

                    const iDepositValue = $('#iDeposit');
                    const iDepositDate = $('#iDepositDate');
                    const depositValue = iDepositValue.val();
                    const depositDate = iDepositDate.val();

                    if (depositValue.trim() === '' || depositDate.trim() === '') {
                        return;
                    }

                    ipcRenderer.send('deposit:add', {'value': depositValue, 'date': depositDate});

                    $("#addDepositModal").modal('close');
                    iDepositValue.val(null);
                    iDepositDate.val(null);
                });
                
            });

            ipcRenderer.on('projects:fetched', (event, projects) => {

                const projectsUl = $("ul#slide-out.side-nav");
                const projectsHeader = $("ul#slide-out li.side-nav-header");

                projectsUl.html("");
                projectsUl.append(projectsHeader);
                projects.forEach((project) => {
                    const li = $('<li></li>')
                        .append('<a class="waves-effect project-item" role="button">'+ project.name +'</a>');
                    
                    // Catch click on a project
                    li.on("click", (event) => {
                        ipcRenderer.send("project:selected", project);
                    });
                    projectsUl.append(li);
                });
            });

            ipcRenderer.on("project:selected:fetched", (event, project) => {
                $("#project-name").text(project.name);
                $("#project-description").text(project.description);
            });

            // After a deposit has been added, refresh list of deposits
            ipcRenderer.on('deposit:fetched', (event, deposits) => {
                console.log(deposits);
            });
        </script>
    </body>

</html>